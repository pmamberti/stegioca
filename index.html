<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stegioca</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #000;
      color: #fff;
      font-family: 'Courier New', monospace;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .screen { display: none; flex-direction: column; align-items: center; gap: 20px; width: 100%; max-width: 700px; padding: 20px; }
    .screen.active { display: flex; }
    h1, h2 { text-align: center; letter-spacing: 2px; }
    .card-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; width: 100%; }
    .card {
      border: 2px solid #444;
      padding: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      transition: border-color 0.15s;
    }
    .card:hover { border-color: #888; }
    .card.selected { border-color: #fff; border-width: 3px; }
    .card canvas { image-rendering: pixelated; width: 128px; height: 128px; }
    .card .name { font-size: 14px; font-weight: bold; }
    .card .race-tag { font-size: 11px; padding: 2px 6px; border: 1px solid #666; text-transform: uppercase; letter-spacing: 1px; }
    .bottom-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-top: 16px; }
    button {
      background: #fff;
      color: #000;
      border: none;
      padding: 10px 24px;
      font-family: inherit;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    button:disabled { opacity: 0.3; cursor: not-allowed; }
    .waiting-cards { display: flex; gap: 24px; justify-content: center; }
    .blink { animation: blink 1s step-end infinite; }
    @keyframes blink { 50% { opacity: 0; } }
    #result-heading { font-size: 28px; }
    #result-narrative { max-width: 500px; text-align: center; line-height: 1.6; }
    .title { font-size: 10px; letter-spacing: 8px; opacity: 0.4; text-transform: uppercase; }
  </style>
</head>
<body>
  <div id="screen-selection" class="screen active">
    <div class="title">STEGIOCA</div>
    <h1>CHOOSE YOUR TEAM</h1>
    <div id="card-grid" class="card-grid">
      <!-- 6 cards injected by JS -->
    </div>
    <div class="bottom-bar">
      <span id="selection-counter">0 / 2 selected</span>
      <button id="btn-start" disabled>START MISSION</button>
    </div>
  </div>

  <div id="screen-waiting" class="screen">
    <h1>MISSION IN PROGRESS</h1>
    <div id="waiting-cards" class="waiting-cards">
      <!-- 2 selected cards shown here -->
    </div>
    <p id="waiting-text" class="blink">...</p>
  </div>

  <div id="screen-result" class="screen">
    <h2 id="result-heading"></h2>
    <div id="result-cards" class="waiting-cards"></div>
    <p id="result-narrative"></p>
    <button id="btn-new-mission">NEW MISSION</button>
  </div>

  <script>
// ── Seeded RNG (mulberry32) ──
function createRNG(seed) {
  return function() {
    seed |= 0; seed = seed + 0x6D2B79F5 | 0;
    let t = Math.imul(seed ^ seed >>> 15, 1 | seed);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}

// ── Name Generation ──
const NAME_SYLLABLES = {
  Human:     { first: ['dev','en','dra','mar','co','li','sa','jon','ray','el','ka','ri'],
               last:  ['ray','sol','kirk','vale','cross','stone','ward','finn'] },
  Tharn:     { first: ['grok','thur','brak','gor','kru','dag','vol','ruk','mog','zar'],
               last:  ['nash','gul','dok','mar','thok','gar','bur'] },
  Cephalid:  { first: ['zyl','thu','pho','gla','cthu','nyl','rhy','vos','qua','mur'],
               last:  ['ath','oth','ull','yth','esh','arn','ix'] },
  Gravborn:  { first: ['bor','ked','sten','dol','grun','tor','hal','vik','mag','rek'],
               last:  ['ax','ven','dig','holm','pit','ore','shaft'] },
  Insectoid: { first: ['zik','chi','kri','bzz','tik','xer','cli','vri','ski','phi'],
               last:  ['xis','tak','rik','zzt','kis','thi','nik'] },
  Construct: { first: ['MK','AX','SR','TX','VK','NX','RX','BX','CX','ZR'],
               last:  ['7','13','99','42','08','31','66','0','77','51'] },
};

function generateName(race, rng) {
  const s = NAME_SYLLABLES[race];
  const first = s.first[Math.floor(rng() * s.first.length)];
  const last = s.last[Math.floor(rng() * s.last.length)];
  if (race === 'Construct') return first + '-' + last;
  return first.charAt(0).toUpperCase() + first.slice(1) + ' ' + last.charAt(0).toUpperCase() + last.slice(1);
}

// ── Race Templates (16 wide x 32 tall, left half only) ──
// '#' = always filled, '.' = always empty, 'x' = variable (seed-driven)
// Right edge (col 15) = character center. Col 0 = outermost edge after mirror.
const RACE_TEMPLATES = {
  // Human: Standard round head, normal neck, straight shoulders
  Human: [
    '................', // row 0  - empty top
    '................', // row 1
    '................', // row 2
    '..........######', // row 3  - top of head
    '.........#######', // row 4
    '........########', // row 5  - head widens
    '.......#########', // row 6
    '.......####x####', // row 7  - forehead, variable hairline
    '.......#########', // row 8  - brow
    '.......##x##.###', // row 9  - eye area (gap=eye)
    '.......#########', // row 10 - nose bridge
    '.......####..x##', // row 11 - cheek area
    '........####.x##', // row 12 - mouth area
    '........########', // row 13 - chin
    '.........#######', // row 14 - jaw line
    '..........######', // row 15 - neck top
    '...........#####', // row 16 - neck
    '...........#####', // row 17 - neck base
    '......##########', // row 18 - shoulders begin
    '....############', // row 19 - shoulders widen
    '..##############', // row 20 - full shoulders
    '.###############', // row 21
    '.###x###########', // row 22 - body with variable detail
    '.###############', // row 23
    '..#####x########', // row 24 - torso detail
    '..##############', // row 25
    '..##############', // row 26
    '..##############', // row 27
    '..##############', // row 28
    '..##############', // row 29
    '..##############', // row 30
    '..##############', // row 31
  ],

  // Tharn: Wide skull, bony ridges, thick neck, massive shoulders, heavy jaw
  Tharn: [
    '................', // row 0
    '.........#......', // row 1  - cranial ridge tip
    '........###.....', // row 2  - ridge widens
    '.......####.#.##', // row 3  - ridge + dome top
    '.......#########', // row 4  - skull top
    '......##########', // row 5  - wide skull
    '.....###########', // row 6
    '.....######x####', // row 7  - brow ridge (heavy)
    '.....###########', // row 8  - brow
    '.....###x##.####', // row 9  - deep-set eye
    '.....###########', // row 10 - nose area
    '.....###########', // row 11 - heavy cheek
    '....############', // row 12 - wide jaw
    '....######x#.x##', // row 13 - jaw detail/tusks
    '....############', // row 14 - jaw base
    '.....###########', // row 15 - chin
    '......##########', // row 16 - thick neck top
    '.....###########', // row 17 - thick neck
    '....############', // row 18 - neck to shoulder
    '..##############', // row 19 - massive shoulders
    '.###############', // row 20
    '################', // row 21 - widest point
    '################', // row 22
    '###x############', // row 23 - armor/plate detail
    '################', // row 24
    '####x###########', // row 25 - body marking
    '################', // row 26
    '################', // row 27
    '################', // row 28
    '################', // row 29
    '################', // row 30
    '################', // row 31
  ],

  // Cephalid: Bulbous oversized dome, tentacles from lower face, thin neck
  Cephalid: [
    '................', // row 0
    '..........######', // row 1  - dome top
    '.......#########', // row 2  - dome widens fast
    '.....###########', // row 3
    '....############', // row 4  - very wide dome
    '...#############', // row 5
    '..##############', // row 6  - widest dome
    '..##############', // row 7
    '..####x#########', // row 8  - surface veins/texture
    '..##############', // row 9
    '...########.####', // row 10 - large eye area
    '...#############', // row 11 - below eye
    '....########x.##', // row 12 - face narrows
    '.....########.##', // row 13 - tentacle roots
    '......##.##.#.##', // row 14 - tentacles separate
    '.......#..#.#.##', // row 15 - tentacles hang
    '.......#..#.#..#', // row 16 - tentacles dangle
    '........#.#..#.#', // row 17 - tentacle tips
    '........#.#..#..', // row 18 - tentacle ends
    '.........x...x..', // row 19 - tentacle tips variable
    '................', // row 20 - gap
    '...........#####', // row 21 - thin neck
    '...........#####', // row 22
    '.........#######', // row 23 - narrow shoulders
    '........########', // row 24
    '.......#########', // row 25 - modest body
    '......##########', // row 26
    '......##x#######', // row 27 - robe/clothing detail
    '......##########', // row 28
    '.....###########', // row 29
    '.....###########', // row 30
    '.....###########', // row 31
  ],

  // Gravborn: Short/stocky, starts lower in frame, visor, respirator, very wide
  Gravborn: [
    '................', // row 0
    '................', // row 1
    '................', // row 2
    '................', // row 3
    '................', // row 4
    '................', // row 5
    '................', // row 6
    '..........######', // row 7  - helmet/head top (starts low)
    '.........#######', // row 8
    '........########', // row 9  - head widens
    '........########', // row 10
    '.......#########', // row 11 - visor band
    '.......####.####', // row 12 - visor slit (eye area)
    '.......#########', // row 13 - visor band bottom
    '.......###xx####', // row 14 - respirator top
    '........##.#.###', // row 15 - respirator grille
    '........##.#.###', // row 16 - respirator detail
    '........########', // row 17 - mask base
    '.........#######', // row 18 - neck (short)
    '.....###########', // row 19 - shoulders (very wide for height)
    '...#############', // row 20
    '..##############', // row 21
    '.###############', // row 22 - massive wide torso
    '################', // row 23
    '################', // row 24 - stocky body
    '###x############', // row 25 - equipment detail
    '################', // row 26
    '####x###########', // row 27 - belt/tool detail
    '################', // row 28
    '################', // row 29
    '################', // row 30
    '################', // row 31
  ],

  // Insectoid: Antennae on top, narrow angular head, compound eye, segmented thorax
  Insectoid: [
    '..............#.', // row 0  - antenna tip left
    '.............#..', // row 1  - antenna stalk
    '............#...', // row 2  - antenna angles in
    '...........#..##', // row 3  - antenna base + head top
    '..........######', // row 4  - narrow head top
    '..........######', // row 5
    '.........#######', // row 6  - head
    '.........##x####', // row 7  - compound eye area
    '.........#.x####', // row 8  - compound eye dots
    '.........#######', // row 9
    '..........#####x', // row 10 - mandible area
    '...........####.', // row 11 - narrow jaw
    '...........###.#', // row 12 - mandible detail
    '............####', // row 13 - thin neck
    '............####', // row 14
    '...........#####', // row 15 - thorax segment 1 top
    '..........######', // row 16
    '.........#######', // row 17 - thorax widens
    '.........#######', // row 18 - segment 1
    '..........######', // row 19 - segment joint (narrows)
    '.........#######', // row 20 - segment 2
    '........########', // row 21
    '........########', // row 22 - widest thorax
    '.........#######', // row 23 - segment joint
    '........########', // row 24 - segment 3
    '.......####x####', // row 25 - pattern detail
    '.......#########', // row 26
    '........########', // row 27 - segment joint
    '.......#########', // row 28 - abdomen
    '.......#########', // row 29
    '........########', // row 30
    '.........#######', // row 31 - abdomen tapers
  ],

  // Construct: Flat-top rectangle head, antenna/sensor, angular, boxy, geometric
  Construct: [
    '................', // row 0
    '................', // row 1
    '..............##', // row 2  - antenna top
    '..............##', // row 3  - antenna stalk
    '.............###', // row 4  - antenna base
    '.........#######', // row 5  - flat head top (sharp edge)
    '.........#######', // row 6
    '.........#######', // row 7  - rectangular head
    '.........#######', // row 8
    '.........###.###', // row 9  - sensor/eye slot
    '.........#######', // row 10
    '.........###..##', // row 11 - speaker grille
    '.........###..##', // row 12 - speaker grille
    '.........#######', // row 13 - head bottom
    '..........#####.', // row 14 - neck connector top
    '...........####.', // row 15 - neck piston
    '...........####.', // row 16 - neck piston
    '..........#####.', // row 17 - neck connector bottom
    '......##########', // row 18 - shoulder plate
    '....############', // row 19 - angular shoulders
    '...#############', // row 20
    '...#############', // row 21 - boxy torso
    '...#############', // row 22
    '...###.#########', // row 23 - chest panel line
    '...###.#########', // row 24
    '...#############', // row 25
    '...##.##########', // row 26 - panel detail
    '...#############', // row 27
    '...#############', // row 28
    '...#############', // row 29
    '...#############', // row 30
    '...#############', // row 31
  ],
};

// ── Portrait Generation ──
function generatePortrait(race, rng) {
  const template = RACE_TEMPLATES[race];
  const size = 32;
  const pixels = new Uint8Array(size * size);

  for (let y = 0; y < size; y++) {
    const row = template[y];
    for (let x = 0; x < size / 2; x++) {
      const ch = row[x];
      let filled = 0;
      if (ch === '#') filled = 1;
      else if (ch === 'x') filled = rng() > 0.5 ? 1 : 0;

      // Set left side
      pixels[y * size + x] = filled;
      // Mirror to right side
      pixels[y * size + (size - 1 - x)] = filled;
    }
  }

  return pixels;
}

function generateCharacter(race, seed) {
  const rng = createRNG(seed);
  return {
    name: generateName(race, rng),
    race: race,
    portrait: generatePortrait(race, rng),
    seed: seed,
  };
}

// ── Card Rendering ──
function renderCard(character) {
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.seed = character.seed;

  // Portrait canvas
  const canvas = document.createElement('canvas');
  canvas.width = 32;
  canvas.height = 32;
  const ctx = canvas.getContext('2d');
  const imageData = ctx.createImageData(32, 32);

  for (let i = 0; i < character.portrait.length; i++) {
    const v = character.portrait[i] ? 255 : 0;
    const idx = i * 4;
    imageData.data[idx] = v;     // R
    imageData.data[idx + 1] = v; // G
    imageData.data[idx + 2] = v; // B
    imageData.data[idx + 3] = 255; // A
  }
  ctx.putImageData(imageData, 0, 0);

  // Name label
  const name = document.createElement('div');
  name.className = 'name';
  name.textContent = character.name;

  // Race tag
  const tag = document.createElement('div');
  tag.className = 'race-tag';
  tag.textContent = character.race;

  card.appendChild(canvas);
  card.appendChild(name);
  card.appendChild(tag);

  return card;
}

const RACES = ['Human', 'Tharn', 'Cephalid', 'Gravborn', 'Insectoid', 'Construct'];

function generateRoster() {
  return RACES.map(race => generateCharacter(race, Math.floor(Math.random() * 100000)));
}

let roster = generateRoster();

function renderSelectionScreen() {
  const grid = document.getElementById('card-grid');
  grid.innerHTML = '';
  roster.forEach((char, i) => {
    const card = renderCard(char);
    card.addEventListener('click', () => handleCardClick(i));
    grid.appendChild(card);
  });
}

// ── Game State ──
let selectedIndices = [];

function updateSelectionUI() {
  const counter = document.getElementById('selection-counter');
  const btn = document.getElementById('btn-start');
  counter.textContent = `${selectedIndices.length} / 2 selected`;
  btn.disabled = selectedIndices.length !== 2;

  document.querySelectorAll('.card').forEach((card, i) => {
    card.classList.toggle('selected', selectedIndices.includes(i));
  });
}

function handleCardClick(index) {
  const pos = selectedIndices.indexOf(index);
  if (pos !== -1) {
    selectedIndices.splice(pos, 1);
  } else if (selectedIndices.length < 2) {
    selectedIndices.push(index);
  }
  updateSelectionUI();
}

// ── Screen Switching ──
function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
}

// ── Mission Flow ──
document.getElementById('btn-start').addEventListener('click', () => {
  startMission();
});

function startMission() {
  const selected = selectedIndices.map(i => roster[i]);
  showScreen('screen-waiting');
  renderWaitingScreen(selected);
  setTimeout(() => showResult(selected), 5000);
}

// ── Waiting Screen ──
function renderWaitingScreen(selected) {
  const container = document.getElementById('waiting-cards');
  container.innerHTML = '';
  selected.forEach(char => container.appendChild(renderCard(char)));
}

// ── Narrative Pools ──
const NARRATIVES = {
  success: [
    "{name1} drew their fire while {name2} secured the objective. Clean extraction.",
    "{name2} almost blew the cover, but {name1} improvised. Mission complete.",
    "Textbook operation. {name1} and {name2} made it look easy.",
    "{name1} cracked the encryption. {name2} held the corridor. Data secured.",
    "Against the odds, {name2} found an alternate route. {name1} covered the exit.",
    "{name1} and {name2} moved like they'd trained together for years. Flawless.",
    "The target never saw {name2} coming. {name1} handled the getaway.",
    "{name1} took point. {name2} watched their six. Not a scratch on either.",
    "Messy start, clean finish. {name2} adapted fast. {name1} kept their nerve.",
    "{name1} disabled the alarms. {name2} grabbed the payload. In and out.",
  ],
  failure: [
    "{name1} took a hit in the first corridor. {name2} dragged them out. No payload.",
    "Bad intel. {name1} and {name2} walked into a trap. Barely made it back.",
    "{name2} froze under fire. {name1} called the abort. Live to fight another day.",
    "The lock was military-grade. {name1} couldn't crack it. {name2} burned through their ammo covering.",
    "{name1} and {name2} got separated in the smoke. Extraction was ugly.",
    "Target was already gone. {name1} and {name2} spent three hours in a dead facility.",
    "{name2} tripped a silent alarm. By the time {name1} noticed, it was too late.",
    "Comms went dark ten minutes in. {name1} and {name2} had to improvise an exit.",
    "The briefing said light resistance. It wasn't. {name2} got {name1} out, but that's all.",
    "{name1} made the call to pull out. {name2} disagreed, but they're both alive.",
  ],
};

// ── Result Screen ──
function showResult(selected) {
  const success = Math.random() < 0.5;
  const pool = success ? NARRATIVES.success : NARRATIVES.failure;
  const template = pool[Math.floor(Math.random() * pool.length)];
  const narrative = template
    .replace(/\{name1\}/g, selected[0].name)
    .replace(/\{name2\}/g, selected[1].name);

  document.getElementById('result-heading').textContent = success ? 'MISSION SUCCESS' : 'MISSION FAILED';
  document.getElementById('result-heading').style.color = success ? '#fff' : '#888';
  document.getElementById('result-narrative').textContent = narrative;

  const container = document.getElementById('result-cards');
  container.innerHTML = '';
  selected.forEach(char => container.appendChild(renderCard(char)));

  showScreen('screen-result');
}

// ── New Mission ──
document.getElementById('btn-new-mission').addEventListener('click', () => {
  selectedIndices = [];
  roster = generateRoster();
  renderSelectionScreen();
  updateSelectionUI();
  showScreen('screen-selection');
});

renderSelectionScreen();
  </script>
</body>
</html>
